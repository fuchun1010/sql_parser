<!DOCTYPE html>
<html>
<head>
	<title>sql2</title>

	<script type="text/javascript">

		const innerOne = {
		  "name": "一个测试标签",
		  "cron": "* 1 * * *",
		  "selectFields": [
		    {
		      "fieldName": "member_id",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "phone_num",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "wx_open_id",
		      "fieldType": "text",
		      "fun": ""
		    }
		  ],
		  "fromTable": "mem_market_tag_datail_record",
		  "conditions": [
		    {
		      "id": "C801DADEB96000015FBE1900673019D8",
		      "conditions": [
		        {
		          "item": {
		            "fieldName": "c1",
		            "fieldType": "number"
		          },
		          "comparisonOperator": "IN_OPTIONS",
		          "selectFields": [
		            {
		              "fieldName": "c1",
		              "fieldType": "text",
		              "fun": ""
		            }
		          ],
		          "fromTable": "mem_market_tag_datail_record",
		          "nodeType": "condition",
		          "conditions": [
		            {
		              "item": {
		                "fieldName": "c2",
		                "fieldType": "number"
		              },
		              "comparisonOperator": "eq",
		              "values": [
		                3
		              ]
		            }
		          ],
		          "groupBy": [
		            {
		              "fieldName": "c1"
		            }
		          ],
		          "hiveBy": [
		            {
		              "fieldName": "x1",
		              "fieldType": "number",
		              "fun": "sum",
		              "opt": "gt",
		              "values": [200]
		            }
		          ]
		        }
		      ],
		      "nodeType": "group",
		      "operator": "and"
		    },
		    {
		      "item": {
		        "fieldName": "eb_total_consume_cnt",
		        "fieldType": "number"
		      },
		      "comparisonOperator": "eq",
		      "values": [
		        "0"
		      ],
		      "id": "C7FEFCFD9DA00001AD5872B1EAF51DAC",
		      "nodeType": "condition"
		    }
		  ],
		  "operator": "and",
		  "groupBy": [
		    {
		      "fieldName": "member_id"
		    },
		    {
		      "fieldName": "phone_num"
		    },
		    {
		      "fieldName": "wx_open_id"
		    }
		  ],
		  "isActive": true,
		  "createUser": {
		    "userName": "娄宏",
		    "userId": "011738"
		  },
		  "divedGroups": {
		    "split": [
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "1884",
		        "category": "random"
		      }
		    ]
		  },
		  "isEnable": true,
		  "startDate": "2017-01-28",
		  "endDate": "2017-01-28",
		  "expireDate": "2017-12-28"
		}

		const simpleOne = {
		  "name": "一个测试标签",
		  "cron": "* 1 * * *",
		  "selectFields": [
		    {
		      "fieldName": "member_id",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "phone_num",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "wx_open_id",
		      "fieldType": "text",
		      "fun": ""
		    }
		  ],
		  "fromTable": "mem_market_tag_datail_record",
		  "conditions": [
		    {
		      "item": {
		        "fieldName": "eb_total_consume_cnt",
		        "fieldType": "number"
		      },
		      "comparisonOperator": "eq",
		      "values": [
		        "0"
		      ],
		      "id": "C7FEFCFD9DA00001AD5872B1EAF51DAC",
		      "nodeType": "condition"
		    },
		    {
		      "item": {
		        "fieldName": "c1",
		        "fieldType": "number"
		      },
		      "comparisonOperator": "eq",
		      "values": [
		        "100"
		      ],
		      "id": "C7FEFCFD9DA00001AD5872B1EAF51DAC",
		      "nodeType": "condition"
		    }
		  ],
		  "operator": "and",
		  "groupBy": [
		    {
		      "fieldName": "member_id"
		    },
		    {
		      "fieldName": "phone_num"
		    },
		    {
		      "fieldName": "wx_open_id"
		    }
		  ],
		  "isActive": true,
		  "createUser": {
		    "userName": "娄宏",
		    "userId": "011738"
		  },
		  "divedGroups": {
		    "split": [
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "1884",
		        "category": "random"
		      }
		    ]
		  },
		  "isEnable": true,
		  "startDate": "2017-01-28",
		  "endDate": "2017-01-28",
		  "expireDate": "2017-12-28"
		}

		const simpleOneWithOr = {
		  "name": "一个测试标签",
		  "cron": "* 1 * * *",
		  "selectFields": [
		    {
		      "fieldName": "member_id",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "phone_num",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "wx_open_id",
		      "fieldType": "text",
		      "fun": ""
		    }
		  ],
		  "fromTable": "mem_market_tag_datail_record",
		  "conditions": [
		    {
		      "item": {
		        "fieldName": "eb_total_consume_cnt",
		        "fieldType": "number"
		      },
		      "comparisonOperator": "eq",
		      "values": [
		        "0"
		      ],
		      "id": "C7FEFCFD9DA00001AD5872B1EAF51DAC",
		      "nodeType": "condition"
		    },
		    {
		      "item": {
		        "fieldName": "c1",
		        "fieldType": "number"
		      },
		      "comparisonOperator": "eq",
		      "values": [
		        "100"
		      ],
		      "id": "C7FEFCFD9DA00001AD5872B1EAF51DAC",
		      "nodeType": "condition"
		    }
		  ],
		  "operator": "or",
		  "groupBy": [
		    {
		      "fieldName": "member_id"
		    },
		    {
		      "fieldName": "phone_num"
		    },
		    {
		      "fieldName": "wx_open_id"
		    }
		  ],
		  "isActive": true,
		  "createUser": {
		    "userName": "娄宏",
		    "userId": "011738"
		  },
		  "divedGroups": {
		    "split": [
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "1884",
		        "category": "random"
		      }
		    ]
		  },
		  "isEnable": true,
		  "startDate": "2017-01-28",
		  "endDate": "2017-01-28",
		  "expireDate": "2017-12-28"
		}

		const multiSub = {
		  "name": "一个测试标签",
		  "cron": "* 1 * * *",
		  "selectFields": [
		    {
		      "fieldName": "member_id",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "phone_num",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "wx_open_id",
		      "fieldType": "text",
		      "fun": ""
		    }
		  ],
		  "fromTable": "mem_market_tag_datail_record",
		  "conditions": [
		    {
		      "id": "C801DADEB96000015FBE1900673019D8",
		      "conditions": [
		        {
		          "item": {
		            "fieldName": "c1",
		            "fieldType": "number"
		          },
		          "comparisonOperator": "IN_OPTIONS",
		          "selectFields": [
		            {
		              "fieldName": "c1",
		              "fieldType": "text",
		              "fun": ""
		            }
		          ],
		          "fromTable": "mem_market_tag_datail_record",
		          "nodeType": "condition",
		          "conditions": [
		            {
		              "item": {
		                "fieldName": "c2",
		                "fieldType": "number"
		              },
		              "comparisonOperator": "eq",
		              "values": [
		                3
		              ]
		            }
		          ],
		          "groupBy": [
		            {
		              "fieldName": "c1"
		            }
		          ],
		          "hiveBy": [
		            {
		              "fieldName": "x1",
		              "fieldType": "number",
		              "fun": "sum",
		              "opt": "gt",
		              "values": [200]
		            }
		          ]
		        }
		      ],
		      "nodeType": "group",
		      "operator": "and"
		    },
		    {
		      "id": "C801DADEB96000015FBE1900673019D8",
		      "conditions": [
		        {
		          "item": {
		            "fieldName": "c6",
		            "fieldType": "number"
		          },
		          "comparisonOperator": "IN_OPTIONS",
		          "selectFields": [
		            {
		              "fieldName": "c7",
		              "fieldType": "text",
		              "fun": ""
		            }
		          ],
		          "fromTable": "mem_market_tag_datail_record",
		          "nodeType": "condition",
		          "conditions": [
		            {
		              "item": {
		                "fieldName": "c8",
		                "fieldType": "number"
		              },
		              "comparisonOperator": "eq",
		              "values": [
		                100
		              ]
		            }
		          ],
		          "groupBy": [
		            {
		              "fieldName": "c9"
		            }
		          ],
		          "hiveBy": [
		            {
		              "fieldName": "c1",
		              "fieldType": "number",
		              "fun": "sum",
		              "opt": "gt",
		              "values": [200]
		            }
		          ]
		        }
		      ],
		      "nodeType": "group",
		      "operator": "and"
		    }
		  ],
		  "operator": "and",
		  "groupBy": [
		    {
		      "fieldName": "member_id"
		    },
		    {
		      "fieldName": "phone_num"
		    },
		    {
		      "fieldName": "wx_open_id"
		    }
		  ],
		  "isActive": true,
		  "createUser": {
		    "userName": "娄宏",
		    "userId": "011738"
		  },
		  "divedGroups": {
		    "split": [
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "1884",
		        "category": "random"
		      }
		    ]
		  },
		  "isEnable": true,
		  "startDate": "2017-01-28",
		  "endDate": "2017-01-28",
		  "expireDate": "2017-12-28"
		}

		const multiSubWithOr = {
		  "name": "一个测试标签",
		  "cron": "* 1 * * *",
		  "selectFields": [
		    {
		      "fieldName": "member_id",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "phone_num",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "wx_open_id",
		      "fieldType": "text",
		      "fun": ""
		    }
		  ],
		  "fromTable": "mem_market_tag_datail_record",
		  "conditions": [
		    {
		      "id": "C801DADEB96000015FBE1900673019D8",
		      "conditions": [
		        {
		          "item": {
		            "fieldName": "c1",
		            "fieldType": "number"
		          },
		          "comparisonOperator": "IN_OPTIONS",
		          "selectFields": [
		            {
		              "fieldName": "c1",
		              "fieldType": "text",
		              "fun": ""
		            }
		          ],
		          "fromTable": "mem_market_tag_datail_record",
		          "nodeType": "condition",
		          "conditions": [
		            {
		              "item": {
		                "fieldName": "c2",
		                "fieldType": "number"
		              },
		              "comparisonOperator": "eq",
		              "values": [
		                3
		              ]
		            }
		          ],
		          "groupBy": [
		            {
		              "fieldName": "c1"
		            }
		          ],
		          "hiveBy": [
		            {
		              "fieldName": "x1",
		              "fieldType": "number",
		              "fun": "sum",
		              "opt": "gt",
		              "values": [200]
		            }
		          ]
		        }
		      ],
		      "nodeType": "group",
		      "operator": "and"
		    },
		    {
		      "id": "C801DADEB96000015FBE1900673019D8",
		      "conditions": [
		        {
		          "item": {
		            "fieldName": "c6",
		            "fieldType": "number"
		          },
		          "comparisonOperator": "IN_OPTIONS",
		          "selectFields": [
		            {
		              "fieldName": "c7",
		              "fieldType": "text",
		              "fun": ""
		            }
		          ],
		          "fromTable": "mem_market_tag_datail_record",
		          "nodeType": "condition",
		          "conditions": [
		            {
		              "item": {
		                "fieldName": "c8",
		                "fieldType": "number"
		              },
		              "comparisonOperator": "eq",
		              "values": [
		                100
		              ]
		            }
		          ],
		          "groupBy": [
		            {
		              "fieldName": "c9"
		            }
		          ],
		          "hiveBy": [
		            {
		              "fieldName": "c1",
		              "fieldType": "number",
		              "fun": "sum",
		              "opt": "gt",
		              "values": [200]
		            }
		          ]
		        }
		      ],
		      "nodeType": "group",
		      "operator": "and"
		    }
		  ],
		  "operator": "or",
		  "groupBy": [
		    {
		      "fieldName": "member_id"
		    },
		    {
		      "fieldName": "phone_num"
		    },
		    {
		      "fieldName": "wx_open_id"
		    }
		  ],
		  "isActive": true,
		  "createUser": {
		    "userName": "娄宏",
		    "userId": "011738"
		  },
		  "divedGroups": {
		    "split": [
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "1884",
		        "category": "random"
		      }
		    ]
		  },
		  "isEnable": true,
		  "startDate": "2017-01-28",
		  "endDate": "2017-01-28",
		  "expireDate": "2017-12-28"
		}

		const nestedOnce = {
		  "name": "一个测试标签",
		  "cron": "* 1 * * *",
		  "selectFields": [
		    {
		      "fieldName": "member_id",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "phone_num",
		      "fieldType": "text",
		      "fun": ""
		    },
		    {
		      "fieldName": "wx_open_id",
		      "fieldType": "text",
		      "fun": ""
		    }
		  ],
		  "fromTable": "mem_market_tag_datail_record",
		  "conditions": [
		    {
		      "id": "C801DADEB96000015FBE1900673019D8",
		      "conditions": [
		        {
		          "item": {
		            "fieldName": "c1",
		            "fieldType": "number"
		          },
		          "comparisonOperator": "IN_OPTIONS",
		          "selectFields": [
		            {
		              "fieldName": "c1",
		              "fieldType": "text",
		              "fun": ""
		            }
		          ],
		          "fromTable": "mem_market_tag_datail_record",
		          "nodeType": "condition",
		          "conditions": [
		            {
		              "item": {
		                "fieldName": "c2",
		                "fieldType": "number"
		              },
		              "comparisonOperator": "eq",
		              "values": [
		                3
		              ]
		            },
		            {
		              "id": "C801DADEB96000015FBE1900673019D8",
		              "conditions": [
		                {
		                  "item": {
		                    "fieldName": "c6",
		                    "fieldType": "number"
		                  },
		                  "comparisonOperator": "IN_OPTIONS",
		                  "selectFields": [
		                    {
		                      "fieldName": "c7",
		                      "fieldType": "text",
		                      "fun": ""
		                    }
		                  ],
		                  "fromTable": "xx",
		                  "nodeType": "condition",
		                  "conditions": [
		                    {
		                      "item": {
		                        "fieldName": "c8",
		                        "fieldType": "number"
		                      },
		                      "comparisonOperator": "eq",
		                      "values": [
		                        100
		                      ]
		                    }
		                  ],
		                  "groupBy": [
		                    {
		                      "fieldName": "c9"
		                    }
		                  ],
		                  "hiveBy": [
		                    {
		                      "fieldName": "c1",
		                      "fieldType": "number",
		                      "fun": "sum",
		                      "opt": "gt",
		                      "values": [
		                        200
		                      ]
		                    }
		                  ]
		                }
		              ],
		              "nodeType": "group",
		              "operator": "and"
		            }
		          ],
		          "groupBy": [
		            {
		              "fieldName": "c1"
		            }
		          ],
		          "hiveBy": [
		            {
		              "fieldName": "x1",
		              "fieldType": "number",
		              "fun": "sum",
		              "opt": "gt",
		              "values": [
		                200
		              ]
		            }
		          ]
		        }
		      ],
		      "nodeType": "group",
		      "operator": "and"
		    }
		  ],
		  "operator": "and",
		  "groupBy": [
		    {
		      "fieldName": "member_id"
		    },
		    {
		      "fieldName": "phone_num"
		    },
		    {
		      "fieldName": "wx_open_id"
		    }
		  ],
		  "isActive": true,
		  "createUser": {
		    "userName": "娄宏",
		    "userId": "011738"
		  },
		  "divedGroups": {
		    "split": [
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "2000",
		        "category": "random"
		      },
		      {
		        "number": "1884",
		        "category": "random"
		      }
		    ]
		  },
		  "isEnable": true,
		  "startDate": "2017-01-28",
		  "endDate": "2017-01-28",
		  "expireDate": "2017-12-28"
		}

		function convertComparator(op) {
			let key = op.toLowerCase()
			let obj = {
				in_options: {
					range: true,
					op: 'in'
				},
				eq: {
					range: false,
					op: '='
				},
				gte: {
					range: false,
					op: '>='
				},
				gt: {
					range: false,
					op: '>'
				},
				lte: {
					range: false,
					op: '<='
				},
				lt: {
					range: false,
					op: '<'
				}
			}
			return obj[key]
		}

		function convertValue(fieldType, range, values) {
			
			let isTextType = fieldType.toLowerCase() === 'Text'
			let v = void 0
			if(range) {
				v = isTextType ? values.map(d => `'${d}'`): values
				v = `(${v.join(',')})`
			}
			else {
				v = isTextType ? values.map(d => `'${d}'`).join(''): values.join('')
			}
			return v
		}

		function toSelectFields(fields) {
			const isExistedSelectFields = fields && Array.isArray(fields) && fields.length > 0
			if(!isExistedSelectFields) {
				return ""
			}
			const rs = ["select"]
			let selectSmt = fields.map(field => {
				let {fieldName, fun} = field
				let f = fun && fun.trim().length > 0 ? `${fun}(${fieldName})`:`${fieldName}`
				return f
			}).join(",")
			rs.push(selectSmt)
			return  rs.join(" ")
		}

		function toFromTable(table) {
			if(!table) {
				return ""
			}
			const rs = ["from", table]
			return rs.join(" ")
		}

		function toWhere(c) {
			
			if(!c){
				return ""
			}

			if(Object.keys(c).length === 0) {
				return ""
			}

			function parse(external, tmp) {
				
				const {conditions, operator} = external

				let len = conditions.length
				let op = operator === 'and' ? "1=1 and": ""
				if(op.trim().length > 0){
					tmp.push(op)
				}

				for(let i = 0; i < len; i++) {
					let c = conditions[i]
					debugger
					if(c.operator) {
						let op = c.operator === 'and' ? "1=1 and": ""
						if(op.trim().length > 0 ) {
							if(tmp.length > 0 && tmp[tmp.length - 1] != op) {
								tmp.push(op)
							}
							
						}
					}

					let isSubQuery = c.nodeType === 'group'

					if(isSubQuery) {
						debugger
						let response =  parse(c, [])
						debugger
						tmp.push(response)
					}
					else {
						let {item:{fieldName,fieldType}, comparisonOperator,selectFields, fromTable, nodeType,  groupBy, hiveBy, values } = c

						let {range, op} = convertComparator(comparisonOperator)
						if(fieldName === 'c6' || fieldName === 'c7') {
							debugger
						}
						tmp.push(fieldName)
						tmp.push(op)
						if(selectFields) {
							tmp.push("(")
							let s = toSelectFields(selectFields)
							tmp.push(s)
							let t = toFromTable(fromTable)
							tmp.push(t)

							if(nodeType === 'group') {
								let smt = ["("]
								//debugger
								let tmpData = Object.assign({}, {conditions:c.conditions})
								//debugger
								let response =  parse(tmpData, smt)
								//debugger
								smt.join(")")
								tmp.push(response)
							}
							else {
								if(c.conditions) {
									//debugger
									let tmpData = Object.assign({}, {conditions:c.conditions, operator})
									//debugger
									let response = parse(tmpData, ["where"])
									//debugger
									tmp.push(response)
								}
								else {
									debugger
									let v = convertValue(fieldType,range, values)
									tmp.push(v)
								}
								
							}

							tmp.push(toGroup(groupBy))

							tmp.push(toHive(hiveBy))

							tmp.push(")")
						}
						else {
							//debugger
							let v = convertValue(fieldType, range, values)
							tmp.push(v)
						}
					}
					//debugger
					//最后还要条条件需要补operator
					if(i != len - 1) {
						let op = (operator || c.operator) === 'and' ? 'and': 'or'
						if(op.trim().length > 0) {
							tmp.push(op)
						}
					}
				}

				return tmp.join(" ")

			} 
			//debugger
			let rs = parse(c, ["where"])
			debugger

			rs = rs.replace(/1=1 and/g, '')
			return rs
		}

		function toGroup(g) {
			if(!g) {
				return ""
			}
			let group = [" group by "]
			let d = g.map(d => d.fieldName).join(",")
			group.push(d)
			return  group.join(" ")
		}

		function toHive(h) {
			if(!h) {
				return ""
			}
			let hive = ["having"]
			let rs = h.map(d => {
				let {fieldName, fun, opt, values, fieldType} = d
				let {range, op} = convertComparator(opt)
				let v = convertValue(fieldType, range, values)
				let rs = fun && fun.trim().length > 0 ? `${fun}(${fieldName}) ${op} ${v}`:`${fieldName} ${op} ${v}`
				return rs
			}).join("and")
			
			hive.push(rs)

			return hive.join(" ")
		}

		function toSql(smt) {
			const {selectFields, fromTable, operator, conditions, groupBy, hiveBy} = smt
			
			const rs = []
			let selectSmt = toSelectFields(selectFields)
			rs.push(selectSmt)

			let fromSmt = toFromTable(fromTable)
			rs.push(fromSmt)


			let whereSmt = toWhere({operator, conditions})
			rs.push(whereSmt)

			rs.push(toGroup(groupBy))

			rs.push(toHive(hiveBy))

			return rs.length > 0 ? rs.join(" "): ""
		}

		const sql = toSql(innerOne)
		
		//const sql = toSql(simpleOne)
		
		//const sql = toSql(simpleOneWithOr)
		
		//const sql = toSql(multiSub)
		
		//const sql = toSql(multiSubWithOr)

		//const sql = toSql(nestedOnce)

		console.log('sql=', sql)


	</script>
</head>

<body>

</body>
</html>