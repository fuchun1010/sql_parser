<!DOCTYPE html>
<html>
<head>
	<title>unionSql</title>

	<script type="text/javascript">
		
		var unionSql = {
		  "operator": "and",
		      "conditions": [
		        {
		          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		          "nodeType": "condition",
		          "comparisonOperator": "IN_OPTIONS",
		          "values": {
		            "valueType": "value",
		            "data": [
		              "BJ"
		            ]
		          },
		          "item": {
		            "fieldName": "location",
		            "fieldType": "Text"
		          }
		        },
		        {
		          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		          "nodeType": "condition",
		          "comparisonOperator": "IN_OPTIONS",
		          "values": {
		            "valueType": "subQuery",
		            "data": {
		              "selectFields": [
		                {
		                  "fieldName": "m1",
		                  "fieldType": "number",
		                  "fun": "sum"
		                }
		              ],
		              "fromTable": "t2",
		              "operator": "and",
		              "conditions": [{
		                    "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		                    "nodeType": "condition",
		                    "comparisonOperator": "eq",
		                    "values": {
		                      "valueType": "value",
		                      "data": [
		                        3
		                      ]
		                    },
		                    "item": {
		                      "fieldName": "c1",
		                      "fieldType": "number"
		                    }
		                  },
		                  {
		                    "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		                    "nodeType": "condition",
		                    "comparisonOperator": "eq",
		                    "item": {
		                      "fieldName": "c10",
		                      "fieldType": "number"
		                    },
		                    "values": {
		                      "valueType": "subQuery",
		                      "data": {
		                        "selectFields": [
		                          {
		                            "fieldName": "m2",
		                            "fieldType": "number"
		                          }
		                        ],
		                        "fromTable": "t3",
		                        "operator": "and",
		                        "conditions": [
		                            {
		                              "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		                              "nodeType": "condition",
		                              "comparisonOperator": "eq",
		                              "values": {
		                                "valueType": "value",
		                                "data": [
		                                  3
		                                ]
		                              },
		                              "item": {
		                                "fieldName": "c5",
		                                "fieldType": "number"
		                              }
		                            }
		                          ]
		                      }
		                    }
		                  }]
		            }
		          },
		          "item": {
		            "fieldName": "location",
		            "fieldType": "Text"
		          }
		        },
		        {
		          "nodeType": "group",
		          "operator": "or",
		          "id": "7b17487d-e274-498b-b7b5-c847854c3376",
		          "conditions": [
		            {
		              "id": "04839167-db37-4be0-92cf-3236291821ff",
		              "nodeType": "condition",
		              "comparisonOperator": "gt",
		              "values":{
		                "valueType": "value",
		                "data": [3000]
		              },
		              "item": {
		                "fieldType": "Numeric",
		                "fieldName": "sales"
		              }
		            },
		            {
		              "id": "bf8ba526-9ed5-49eb-b0f4-e8f73093892e",
		              "nodeType": "condition",
		              "comparisonOperator": "eq",
		              "values": {
		                "valueType": "value",
		                "data": [4]
		              },
		              "item": {
		                "fieldType": "Numeric",
		                "fieldName": "id"
		              }
		            }
		          ]
		        }
		      ]
		}

		var commonWhereWithOutSubquery = {
			"operator": "and",
      "conditions": [
        {
          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
          "nodeType": "condition",
          "comparisonOperator": "IN_OPTIONS",
          "values": {
            "valueType": "value",
            "data": [
              "BJ"
            ]
          },
          "item": {
            "fieldName": "location",
            "fieldType": "Text"
          }
        },
        {
          "nodeType": "group",
          "operator": "or",
          "id": "7b17487d-e274-498b-b7b5-c847854c3376",
          "conditions": [
            {
              "id": "04839167-db37-4be0-92cf-3236291821ff",
              "nodeType": "condition",
              "comparisonOperator": "gt",
              "values": {
                "valueType": "value",
                "data": [
                  3000
                ]
              },
              "item": {
                "fieldType": "Numeric",
                "fieldName": "sales"
              }
            },
            {
              "id": "bf8ba526-9ed5-49eb-b0f4-e8f73093892e",
              "nodeType": "condition",
              "comparisonOperator": "eq",
              "values": {
                "valueType": "value",
                "data": [
                  3
                ]
              },
              "item": {
                "fieldType": "Numeric",
                "fieldName": "id"
              }
            }
          ]
        }
      ]
    }

    var whereConditionWithSubquery = {
    	"operator": "and",
      "conditions": [
        {
          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
          "nodeType": "condition",
          "comparisonOperator": "IN_OPTIONS",
          "values": {
            "valueType": "value",
            "data": [
              "BJ"
            ]
          },
          "item": {
            "fieldName": "location",
            "fieldType": "Text"
          }
        },
        {
          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
          "nodeType": "condition",
          "comparisonOperator": "IN_OPTIONS",
          "values": {
            "valueType": "subQuery",
            "data": {
              "selectFields": [
                {
                  "fieldName": "m1",
                  "fieldType": "number",
                  "fun": "sum"
                }
              ],
              "fromTable": "t2",
              "operator": "and",
              "conditions": [
                {
                  "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
                  "nodeType": "condition",
                  "comparisonOperator": "eq",
                  "values": {
                    "valueType": "value",
                    "data": [
                      3
                    ]
                  },
                  "item": {
                    "fieldName": "c1",
                    "fieldType": "number"
                  }
                },
                {
                  "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
                  "nodeType": "condition",
                  "comparisonOperator": "eq",
                  "values": {
                    "valueType": "subQuery",
                    "data": {
                      "selectFields": [
                        {
                          "fieldName": "m2",
                          "fieldType": "number"
                        }
                      ],
                      "fromTable": "t3",
                      "operator": "and",
                        "conditions": [
                          {
                            "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
                            "nodeType": "condition",
                            "comparisonOperator": "eq",
                            "values": {
                              "valueType": "value",
                              "data": [
                                3
                              ]
                            },
                            "item": {
                              "fieldName": "c5",
                              "fieldType": "number"
                            }
                          }
                       ]
                    }
                  }
                }
              ]
            }
          },
          "item": {
            "fieldName": "location",
            "fieldType": "Text"
          }
        }
      ]
    }

		var unionSql2 = {
		  "operator": "union",
		  "conditions": [
		    {
		      "selectFields": [
		        {
		          "fieldName": "c1",
		          "fieldType": "number",
		          "fun": ""
		        },
		        {
		          "fieldName": "c2",
		          "fieldType": "number",
		          "fun": ""
		        }
		      ],
		      "fromTable": "t1",
		      "operator": "and",
		      "conditions": [
		        {
		          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		          "nodeType": "condition",
		          "comparisonOperator": "IN_OPTIONS",
		          "values": {
		            "valueType": "value",
		            "data": [
		              "BJ"
		            ]
		          },
		          "item": {
		            "fieldName": "location",
		            "fieldType": "Text"
		          }
		        }
		      ],
		      "groupBy": [
		        {
		          "fieldName": "c3"
		        }
		      ],
		      "hiveBy": {
			      "operator": "or",
			      "conditions": [
			        {
			          "id": "1",
			          "nodeType": "condition",
			          "comparisonOperator": "gt",
			          "fieldName": "c1",
			          "fieldType": "number",
			          "fun": "sum",
			          "values": {
			            "valueType": "value",
			            "data": [
			              120
			            ]
			          }
			        },
			        {
			        	"id": "2",
			        	"operator": "and",
			        	"nodeType": "group",
			        	"conditions": [
			        		{
			        			"id": "3",
			        			"nodeType": "condition",
			        			"comparisonOperator": "eq",
			        			"fieldName": "c2",
					          "fieldType": "number",
					          "fun": "avg",
					          "values": {
				              "valueType": "value",
				              "data": [
				                200
				              ]
				            }
			        		},{
			        			"id": "4",
			        			"nodeType": "condition",
			        			"nodeType": "condition",
			        			"comparisonOperator": "eq",
			        			"fieldName": "c2",
					          "fieldType": "number",
					          "fun": "count",
					          "values": {
				              "valueType": "value",
				              "data": [
				                100
				              ]
				            }
			        		}
			        	]
			        }
			      ]
			    }
		    }
		  ]
		}

		var unionSql3 = {
		  "operator": "union",
		  "conditions": [
		    {
		      "selectFields": [
		        {
		          "fieldName": "c1",
		          "fieldType": "number",
		          "fun": ""
		        },
		        {
		          "fieldName": "c2",
		          "fieldType": "number",
		          "fun": ""
		        }
		      ],
		      "fromTable": "t1",
		      "operator": "and",
		      "conditions": [
		        {
		          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		          "nodeType": "condition",
		          "comparisonOperator": "IN_OPTIONS",
		          "values": {
		            "valueType": "value",
		            "data": [
		              "BJ"
		            ]
		          },
		          "item": {
		            "fieldName": "location",
		            "fieldType": "Text"
		          }
		        }
		      ],
		      "groupBy": [
		        {
		          "fieldName": "c3"
		        }
		      ],
		      "hivingBy": {
		        "operator": "and",
		        "conditions": [
		          {
		            "id": "xxxx",
		            "nodeType": "condition",
		            "comparisonOperator": "",
		            "values": [
		              {
		                "valueType": "value",
		                "data": [
		                  "BJ"
		                ]
		              }
		            ]
		          }
		        ]
		      }
		    }
		  ]
		}

		var andOrSql4 = {
      "operator": "or",
      "conditions": [
        {
          "id": "1",
          "nodeType": "condition",
          "comparisonOperator": "gt",
          "item": {
          	"fieldName": "c1",
          	"fieldType": "number"
          },
          "fun": "",
          "values": {
            "valueType": "value",
            "data": [
              120
            ]
          }
        },
        {
        	"id": "2",
        	"operator": "and",
        	"nodeType": "group",
        	"conditions": [
        		{
        			"id": "3",
        			"nodeType": "condition",
        			"comparisonOperator": "eq",
        			"item": {
		          	"fieldName": "c3",
		          	"fieldType": "number"
		          },
		          "fun": "",
		          "values": {
	              "valueType": "value",
	              "data": [
	                200
	              ]
	            }
        		},{
        			"id": "4",
        			"nodeType": "condition",
        			"comparisonOperator": "eq",
        			"item": {
        				"fieldName": "c4",
		          	"fieldType": "number"
        			},
		          "fun": "",
		          "values": {
	              "valueType": "value",
	              "data": [
	                100
	              ]
	            }
        		}
        	]
        }
      ]
    }

		var hiveBy = {
      "operator": "or",
      "conditions": [
        {
          "id": "1",
          "nodeType": "condition",
          "comparisonOperator": "gt",
          "fun": "sum",
          "values": {
            "valueType": "value",
            "data": [
              120
            ]
          },
          "item": {
            "fieldName": "c1",
            "fieldType": "number"
          }
        },
        {
        	"id": "2",
        	"operator": "and",
        	"nodeType": "group",
        	"conditions": [
        		{
        			"id": "3",
        			"nodeType": "condition",
        			"comparisonOperator": "eq",
        			"item": {
		            "fieldName": "c1",
		            "fieldType": "number"
		          },
		          "fun": "avg",
		          "values": {
	              "valueType": "value",
	              "data": [
	                200
	              ]
	            }
        		},{
        			"id": "4",
        			"nodeType": "condition",
        			"nodeType": "condition",
        			"comparisonOperator": "eq",
        			"item": {
		            "fieldName": "c2",
		            "fieldType": "number"
		          },
		          "fun": "count",
		          "values": {
	              "valueType": "value",
	              "data": [
	                100
	              ]
	            }
        		}
        	]
        }
      ]
    }

    var havingBy2 = {
      "operator": "or",
      "conditions": [
        {
          "id": "1",
          "nodeType": "condition",
          "comparisonOperator": "gt",
          "item": {
          	"fieldName": "c1",
          	"fieldType": "number"
          },
          "fun": "sum",
          "values": {
            "valueType": "value",
            "data": [
              120
            ]
          }
        },
        {
        	"id": "2",
        	"operator": "and",
        	"nodeType": "group",
        	"conditions": [
        		{
        			"id": "3",
        			"nodeType": "condition",
        			"comparisonOperator": "eq",
        			"item": {
		          	"fieldName": "c2",
		          	"fieldType": "number"
		          },
		          "fun": "avg",
		          "values": {
	              "valueType": "value",
	              "data": [
	                200
	              ]
	            }
        		},{
        			"id": "3",
        			"nodeType": "condition",
        			"nodeType": "condition",
        			"comparisonOperator": "eq",
        			"item": {
        				"fieldName": "c4",
		          	"fieldType": "number"
        			},
		          "fun": "count",
		          "values": {
	              "valueType": "value",
	              "data": [
	                100
	              ]
	            }
        		}
        	]
        },
        {
        	"id": "4",
        	"operator": "union",
        	"nodeType": "condition",
          "item": {
          	"fieldName": "c4",
          	"fieldType": "number"
          },
        	"comparisonOperator": "IN_OPTIONS",
        	"values": {
        		"valueType": "subQuery",
        		"data": [
	        		{
	        			"selectFields": [
	                {
	                  "fieldName": "m1",
	                  "fieldType": "number",
	                  "fun": "sum"
	                }
	              ],
	              "fromTable": "t2",
	              "operator": "and",
	              "conditions":[
			             {
			        			"id": "3",
			        			"nodeType": "condition",
			        			"comparisonOperator": "eq",
			        			"item":{
			        				"fieldName": "c2",
					          	"fieldType": "number"
			        			},
					          "fun": "avg",
					          "values": {
				              "valueType": "value",
				              "data": [
				                200
				              ]
				            }
			        		},
			        		{
			        			"id": "4",
			        			"nodeType": "condition",
			        			"nodeType": "condition",
			        			"comparisonOperator": "eq",
			        			"item":{
			        				"fieldName": "c2",
					          	"fieldType": "number"
			        			},
					          "fun": "count",
					          "values": {
				              "valueType": "value",
				              "data": [
				                100
				              ]
				            }
			        		}
	              ],
	              "groupBy": [
					        {
					          "fieldName": "c3"
					        }
					      ]
	        		}
        		]
        	}
        }
      ]
    }

    var entireSql1 = {
    	"id": "753d6724-a89a-4da9-8c95-c2d25a864c23",
		  "isActive":true,
		  "tagLevelId": "xxxxx",
		  "count": 0,
		  "name": "一个测试标签",
		  "fromTable": 122,
		  "selectFields":[
		    {
		      "fieldName": "c1",
		      "fieldType": "Text",
		      "fun": ""
		    }
		  ],
		  "operator": "union",
		  "conditions": [
		    {
		      "selectFields": [
		        {
		          "fieldName": "c1",
		          "fieldType": "number",
		          "fun": ""
		        },
		        {
		          "fieldName": "c2",
		          "fieldType": "number",
		          "fun": ""
		        }
		      ],
		      "fromTable": "t1",
		      "operator": "and",
		      "conditions": [
		        {
		          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		          "nodeType": "condition",
		          "comparisonOperator": "IN_OPTIONS",
		          "values": {
		            "valueType": "value",
		            "data": [
		              "BJ"
		            ]
		          },
		          "item": {
		            "fieldName": "location",
		            "fieldType": "Text"
		          }
		        },
		        {
		          "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		          "nodeType": "condition",
		          "comparisonOperator": "IN_OPTIONS",
		          "values": {
		            "valueType": "subQuery",
		            "data": {
		              "selectFields": [
		                {
		                  "fieldName": "m1",
		                  "fieldType": "number",
		                  "fun": "sum"
		                }
		              ],
		              "fromTable": "t2",
		              "operator": "and",
		              "conditions": {
		                "operator": "and",
		                "conditions": [
		                  {
		                    "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		                    "nodeType": "condition",
		                    "comparisonOperator": "eq",
		                    "values": {
		                      "valueType": "value",
		                      "data": [
		                        3
		                      ]
		                    },
		                    "item": {
		                      "fieldName": "c1",
		                      "fieldType": "number"
		                    }
		                  },
		                  {
		                    "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		                    "nodeType": "condition",
		                    "comparisonOperator": "eq",
		                    "values": {
		                      "valueType": "subQuery",
		                      "data": {
		                        "selectFields": [
		                          {
		                            "fieldName": "m2",
		                            "fieldType": "number"
		                          }
		                        ],
		                        "fromTable": "t3",
		                        "operator": "and",
		                        "conditions": {
		                          "operator": "and",
		                          "conditions": [
		                            {
		                              "id": "e8a19125-bbac-4b1b-b69f-bfdce7233718",
		                              "nodeType": "condition",
		                              "comparisonOperator": "eq",
		                              "values": {
		                                "valueType": "value",
		                                "data": [
		                                  3
		                                ]
		                              },
		                              "item": {
		                                "fieldName": "c5",
		                                "fieldType": "number"
		                              }
		                            }
		                          ]
		                        }
		                      }
		                    }
		                  }
		                ]
		              }
		            }
		          },
		          "item": {
		            "fieldName": "location",
		            "fieldType": "Text"
		          }
		        },
		        {
		          "nodeType": "group",
		          "operator": "or",
		          "id": "7b17487d-e274-498b-b7b5-c847854c3376",
		          "conditions": [
		            {
		              "id": "04839167-db37-4be0-92cf-3236291821ff",
		              "nodeType": "condition",
		              "comparisonOperator": "gt",
		              "values": {
		              	"valueType": "value",
		              	"data":[3000]
		              },
		              "item": {
		                "fieldType": "Numeric",
		                "fieldName": "sales"
		              }
		            },
		            {
		              "id": "bf8ba526-9ed5-49eb-b0f4-e8f73093892e",
		              "nodeType": "condition",
		              "comparisonOperator": "eq",
		              "values": {
		              	"valueType": "value",
		              	"data":[3]
		              },
		              "item": {
		                "fieldType": "Numeric",
		                "fieldName": "id"
		              }
		            }
		          ]
		        }
		      ],
		      "groupBy": [
		        {
		          "fieldName": "c3"
		        }
		      ],
		      "hiveBy": {
			      "operator": "or",
			      "conditions": [
			        {
			          "id": "1",
			          "nodeType": "condition",
			          "comparisonOperator": "gt",
			          "item": {
			          	"fieldName": "c1",
			          	"fieldType": "number"
			          },
			          "fun": "sum",
			          "values": {
			            "valueType": "value",
			            "data": [
			              120
			            ]
			          }
			        },
			        {
			        	"id": "2",
			        	"operator": "and",
			        	"nodeType": "group",
			        	"conditions": [
			        		{
			        			"id": "3",
			        			"nodeType": "condition",
			        			"comparisonOperator": "eq",
			        			"item": {
					          	"fieldName": "c2",
					          	"fieldType": "number"
					          },
					          "fun": "avg",
					          "values": {
				              "valueType": "value",
				              "data": [
				                200
				              ]
				            }
			        		},{
			        			"id": "4",
			        			"nodeType": "condition",
			        			"comparisonOperator": "eq",
			        			"item": {
			        				"fieldName": "c2",
					          	"fieldType": "number"
			        			},
					          "fun": "count",
					          "values": {
				              "valueType": "value",
				              "data": [
				                100
				              ]
				            }
			        		}
			        	]
			        }
			      ]
			    }
		    }
		  ],
		  "cron": "* 1 * * *",
		  "createUser": {
		    "userId": "xxx",
		    "userName": "xxxx"
		  },
		  "isEnable": true,
		  "startDate": "2017-01-28",
		  "endDate": "2017-01-28",
		  "expireDate": "2017-12-28",
		  "groupBy":[
		    {
		      "fieldName": "xxxxx"
		    }
		  ],
		  "expireDate": "2017-12-28",
		  "createDate": 1522302048038
    }


    function convertSubQuery(record, c = []) {
    	debugger
			let {operator, conditions} = record
			//TODO 这个or有时候是需要添加的
			let prefix = operator === 'or' ? `(`: `(1 = 1 and `
			c.push(prefix)
			let len = (Array.isArray(conditions) && conditions.length) || 0
			if(len === 0) {
				return ""
			}
			//debugger
			for(let i = 0; i < len; i++) {
				let cdt = conditions[i]
				let {nodeType} = cdt 
				let isCondition = nodeType === 'condition'
				//debugger
				if(isCondition) {
					let {comparisonOperator, item, fun, values} = cdt
					//debugger
					let {op} = convertComparator(comparisonOperator)
					let funField = void 0
					let isCommonValue = cdt.values.valueType === 'value'
					
					if(isCommonValue) {
						funField = (fun && fun.trim().length > 0) ? `${fun}(${item.fieldName})`: item.fieldName
						c.push(funField)
						c.push(op)
						c.push(values.data.join(''))
						let isAddedAnd = i != (len - 1)
						if(isAddedAnd) {
							c.push(operator)
						}
					}
					else {
						//TODO subQuery
						//debugger
						let {selectFields, fromTable, operator, conditions, groupBy, hiveBy} = values.data
						//c.push(operator)
						//funField = (fun && fun.trim().length > 0) ? `${fun}(${item.fieldName})`: item.fieldName
						funField = selectFields.map(({fieldName, fun}) => (fun && fun.trim().length > 0) ? `${fun}(${fieldName})`: fieldName).join(" ")
						//debugger
						c.push(funField)
						c.push(op)
						c.push(" ( ")
						selectFields = toSelectSmt(selectFields)
						c.push(selectFields)
						fromTable = toTable(fromTable)
						c.push(fromTable)
						let where = toWhere({operator, conditions}, [])
						groupBy = toGroupSmt(groupBy)
						hiveBy = toHive(hiveBy)
						if(where.length > 0) {
							c.push(` where ${where}`)
						}
						
						if(groupBy.length > 0) {
							c.push(groupBy.join(" "))
						}
						
						if(hiveBy.length > 0) {
							c.push(hiveBy.join(" "))
						}
						c.push(" ) ")
					}

				}
				else {
					//process group
					let result = convertSubQuery(cdt, [])
					//debugger
					c.push(result)
				}
			}
			c.push(')')
			return c.join(' ')
		}

		/**
		 *  递归解析hiving
		 * @param  {[type]} having [description]
		 * @return {[type]}        [description]
		 */
		function toHaving(having, c = []) {
			function convertHaving(having, c = []) {
				let {operator, conditions} = having
				let prefix = operator === 'or' ? `(`: `(1 = 1 and `
				c.push(prefix)
				let len = (Array.isArray(conditions) && conditions.length) || 0
				for(let i = 0; i < len; i++) {
					let cdt = conditions[i]
					let {nodeType} = cdt 
					let isCondition = nodeType === 'condition'
					if(isCondition) {
						//debugger
						let {comparisonOperator, item:{fieldName}, fun, values:{valueType, data}} = cdt
						//debugger
						let {op} = convertComparator(comparisonOperator)
						let funField = (fun && fun.trim().length > 0) ? `${fun}(${fieldName})`: fieldName
						let isCommonValue = valueType === 'value'
						
						if(isCommonValue) {
							c.push(funField)
							c.push(op)
							c.push(data.join(''))
							let isAddedAnd = i != (len - 1)
							if(isAddedAnd) {
								c.push(operator)
							}
						}
						else {
							//TODO subQuery
							let {selectFields, fromTable, operator, conditions, groupBy, hiveBy} = data[0]
							c.push(operator)
							c.push(funField)
							c.push(op)
							c.push(" ( ")
							selectFields = `select ${selectFields ? selectFields.map(field => {
								let {fun,fieldName} = field
								return (fun && fun.trim().length > 0) ? `${fun}(${fieldName})`: filename
							}).join(','): ''} `

							c.push(selectFields)
							fromTable = ` from ${fromTable} `
							c.push(fromTable)
							let where = toWhere({operator, conditions}, [])
							groupBy = groupBy ? ` group by ${groupBy.map(g => g.fieldName).join(',')} `:''
							hiveBy = hiveBy ? ` having ${hiveBy.map(h => h.fieldName).join(',')}`: ''
							c.push(` where ${where}`)
							if(groupBy.trim().length > 0) {
								c.push(groupBy)
							}
							
							if(hiveBy.trim().length > 0) {
								c.push(hiveBy)
							}
							c.push(" ) ")
						}

					}
					else {
						//process group
						let result = convertHaving(cdt, [])
						//debugger
						c.push(result)
					}
				}
				c.push(')')
				return c.join(' ')
			}
			const str = convertHaving(having, [])
			//debugger
			return `having ${str}`
		}
		
		/**
		 * 符号转换
		 * @param  {[type]} op [description]
		 * @return {[type]}    [description]
		 */
		function convertComparator(op) {
			let key = op.toLowerCase()
			let obj = {
				in_options: {
					range: true,
					op: 'in'
				},
				eq: {
					range: false,
					op: '='
				},
				gte: {
					range: false,
					op: '>='
				},
				gt: {
					range: false,
					op: '>'
				},
				lte: {
					range: false,
					op: '<='
				},
				lt: {
					range: false,
					op: '<'
				}
			}
			return obj[key]
		}

		function toWhere(inputs, sql = []) {
			debugger
			const {operator, conditions} = inputs
			let isUnion = operator === 'union'
			let len = (Array.isArray(conditions) && conditions.length) || 0
			let prefix = void 0
			let isAdded = false
			if(!isUnion) {
				prefix = operator === 'and' ? `( 1 = 1 ${operator} `: " ( "
				sql.push(prefix)
				isAdded = true
			}
			for(let i = 0; i < len; i++) {
				let c = conditions[i]
				if(isUnion) {
					let {selectFields, fromTable, operator, conditions, groupBy, hivingBy} = c
					let selectSmt = `select ${selectFields.map(field => field.fieldName).join(',')}`
					sql.push(selectSmt)
					let fromSmt = ` from ${fromTable} where `
					sql.push(fromSmt)
					let whereSmt = toWhere({operator, conditions}, [])
					debugger
					sql.push(whereSmt)
					let groupSmt = groupBy ?` group by ${groupBy.map(field => field.fieldName).join(',')} `: ''
					if(groupSmt.trim().length > 0) {
						sql.push(groupSmt)
					}
				}
				else {
					//process condition
					let isNotLast = i != (len - 1)
					debugger
					let {nodeType} = c
					let isCondition = nodeType === 'condition'
					
					if(isCondition) {
						// process common condition
						debugger
						let isCommonConidtion = c.values.valueType === 'value'
						if(isCommonConidtion) {
							let {comparisonOperator, values:{valueType, data}, item:{fieldType, fieldName}} = c
							let {range, op} = convertComparator(comparisonOperator)
							let isTextType = fieldType === 'Text'
							let v = void 0
							if(range) {
								v = isTextType ? data.map(d => `'${d}'`): data
								v = `(${v.join(',')})`
							}
							else {
								v = isTextType ? data.map(d => `'${d}'`).join(''): data.join('')
							}
							sql.push(fieldName)
							sql.push(op)
							sql.push(v)
							
						}
						else {
							// TODO process subQuery
							debugger
							let rs = convertSubQuery(c.values.data, [])
							sql.push(rs)
							//debugger

						}

						if(isNotLast) {
							sql.push(operator)
						}
						
					}
					else {
						//debugger
						let result = toWhere(c, [])
						let exists = result && result.length > 0
						if(exists) {
							sql.push(result)
						}
					}
					//sql.push(")")
				}
				
			}

			if(isAdded) {
				sql.push(")")
			}

			return sql.join(" ")
		}

		function toSelectSmt(selectedFields) {
			let isValidate = Array.isArray(selectedFields) && selectedFields.length > 0
			if(!isValidate) {
				throw  new  Error('非法的selectedFields key')
			}
			let result = selectedFields.map(field => {
					let {fieldName,fun} = field
					if(fun) {
						return `${fun}(${fieldName})`
					}
					else {
						return fieldName
					}
			})
			result = result.join(",")
			return `select ${result} `
		}

		function toTable(fromTable) {
			if(!fromTable) {
				throw  new Error('fromTable不允许是空值')
			}
			let result = `from ${fromTable} `
			return result
		}

		function toGroupSmt(groupBy) {
			let isValidate = Array.isArray(groupBy) && groupBy.length > 0
			if(!isValidate) {
				return ''
			}
			let result = groupBy.map(g => g.fieldName).join(',')
			return `group by ${result}`
		}

		function toHive(hiveBy) {
			let isValidate = Array.isArray(hiveBy) && hiveBy.length > 0
			if(!isValidate) {
				return ''
			}
			let result = toHaving(hiveBy, [])
			return result
		}

		function toEntireSql(inputSql) {
			function composeSql(operator, conditions, splinter = []) {
				debugger
				if(operator === 'union') {
					for(let c of conditions) {
						splinter.push('union')
						splinter.push('(')
						debugger
						let {selectFields, operator, conditions, fromTable, groupBy, hiveBy} = c
						//解析sql各个部分
						let selectSmt = toSelectSmt(selectFields)
						let tableSmt = toTable(fromTable)
						let whereSmt = toWhere({operator, conditions}, [])
						let groupSmt = toGroupSmt(groupBy)
						let hiveSmt = toHive(hiveBy)

						splinter.push(selectSmt)
						splinter.push(tableSmt)
						splinter.push(whereSmt)
						splinter.push(groupSmt)
						splinter.push(hiveSmt)

						debugger
						let tmpSql = composeSql(operator,conditions,[])
						debugger
						splinter.push(')')
						tmpSql = splinter.join(" ")
						debugger
						sqlSmt.push(tmpSql)
						
						debugger
					}
				}

				debugger				
				return splinter
			}

			debugger
			let sqlSmt = []

			let {selectFields, operator, conditions, fromTable, groupBy, hiveBy} = inputSql

			let selectSmt = toSelectSmt(selectFields)
			sqlSmt.push(selectSmt)
			let tableSmt = toTable(fromTable)
			sqlSmt.push(tableSmt)
			
			//TODO 这个地方需要递归判断是否有union
			if(operator === 'union') {
				composeSql(operator, conditions, [])
			}
			else {
				let whereSmt = toWhere({operator, conditions}, [])
				sqlSmt.push(whereSmt)
			}
			let groupSmt = toGroupSmt(groupBy)
			let hiveSmt = toHive(hiveBy)
			//添加sql的片段
			sqlSmt.push(groupSmt)
			sqlSmt.push(hiveSmt)

			return sqlSmt.join(" ")
		}

		// const str =  toWhere(unionSql, [])
		// console.log(str)
		 
		// const str = toHaving(hiveBy, [])
		// console.log(str)
		 
		// const str = toHaving(havingBy2, [])
		// console.log(str)
		
		// const sql = toEntireSql(entireSql1)
		// console.log(sql)
		 
		// const str = toWhere(commonWhereWithOutSubquery)
		// console.log(str)
		
		//TODO 有bug
		const str = toWhere(whereConditionWithSubquery)
		console.log(str)

	</script>
</head>

<body>
	
</body>

</body>
</html>